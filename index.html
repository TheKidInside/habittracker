<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Habits">
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <title>Habits</title>
  <style>
    :root {
      --green:      #22c55e;
      --green-bg:   #dcfce7;
      --green-txt:  #15803d;
      --orange:     #f97316;
      --orange-bg:  #ffedd5;
      --orange-txt: #c2410c;
      --grey:       #9ca3af;
      --grey-bg:    #f3f4f6;
      --grey-txt:   #6b7280;
      --purple:     #6366f1;
      --purple-bg:  #ede9fe;
      --purple-txt: #4338ca;
      --bg:         #f1f5f9;
      --card:       #ffffff;
      --text:       #0f172a;
      --muted:      #64748b;
      --border:     #e2e8f0;
      --r:          16px;
      --header-h:   76px;
      --nav-h:      68px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 430px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      flex-shrink: 0;
      background: var(--card);
      padding: calc(env(safe-area-inset-top, 12px) + 12px) 18px 12px;
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }
    .header-eye   { font-size: 11px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); }
    .header-title { font-size: 24px; font-weight: 800; }

    /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
    #app {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
    .view {
      display: none;
      height: 100%;
      flex-direction: column;
    }
    .view.active { display: flex; }

    /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
    .bottom-nav {
      flex-shrink: 0;
      display: flex;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding-bottom: max(env(safe-area-inset-bottom, 12px), 12px);
    }
    .nav-btn {
      flex: 1; border: none; background: none;
      font-size: 10px; font-weight: 600; letter-spacing: .04em; text-transform: uppercase;
      color: var(--muted); cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 4px; padding: 10px 8px; transition: color .15s;
    }
    .nav-btn svg    { width: 22px; height: 22px; }
    .nav-btn.active { color: var(--purple); }

    /* ‚îÄ‚îÄ JDI BAR (Today) ‚îÄ‚îÄ */
    .jdi-bar {
      flex-shrink: 0;
      background: var(--purple-bg);
      border-bottom: 1px solid #ddd6fe;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .jdi-bar-label {
      flex: 1;
      font-size: 13px; font-weight: 700;
      text-transform: uppercase; letter-spacing: .06em;
      color: var(--purple-txt);
    }
    .jdi-bar-label span {
      display: block;
      font-size: 11px; font-weight: 500;
      text-transform: none; letter-spacing: 0;
      color: var(--purple); margin-top: 1px;
    }
    .jdi-controls { display: flex; align-items: center; gap: 10px; }
    .jdi-num {
      font-size: 38px; font-weight: 900; color: var(--purple);
      min-width: 48px; text-align: center; line-height: 1;
    }
    .jdi-btn {
      border: none; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; transition: transform .1s;
    }
    .jdi-btn:active { transform: scale(.88); }
    .jdi-minus { width: 38px; height: 38px; font-size: 20px; background: #c7d2fe; color: var(--purple-txt); }
    .jdi-plus  { width: 48px; height: 48px; font-size: 26px; background: var(--purple); color: #fff;
                 box-shadow: 0 3px 12px rgba(99,102,241,.4); }

    /* ‚îÄ‚îÄ TODAY SCROLL AREA ‚îÄ‚îÄ */
    .today-scroll {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 24px;
    }

    /* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
    .summary-strip {
      flex-shrink: 0;
      display: flex; gap: 8px;
      padding: 10px 14px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .s-pill { flex: 1; border-radius: 12px; padding: 10px 6px; text-align: center; }
    .s-pill-num { font-size: 24px; font-weight: 800; line-height: 1; }
    .s-pill-lbl { font-size: 10px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; margin-top: 2px; }
    .sp-full   { background: var(--green-bg);  }
    .sp-full   .s-pill-num, .sp-full .s-pill-lbl   { color: var(--green-txt); }
    .sp-nz     { background: var(--orange-bg); }
    .sp-nz     .s-pill-num, .sp-nz .s-pill-lbl     { color: var(--orange-txt); }
    .sp-missed { background: var(--grey-bg);   }
    .sp-missed .s-pill-num, .sp-missed .s-pill-lbl  { color: var(--grey-txt); }

    .section-lbl {
      font-size: 11px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase;
      color: var(--muted); margin: 16px 2px 9px;
    }

    .tap-hint { font-size: 12px; color: var(--muted); margin-bottom: 4px; text-align: center; }

    /* ‚îÄ‚îÄ HABIT CARD ‚îÄ‚îÄ */
    .habit-card {
      background: var(--card);
      border-radius: var(--r);
      padding: 13px 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 11px;
      cursor: pointer;
      border: 2.5px solid transparent;
      transition: all .12s;
      user-select: none;
    }
    .habit-card:active         { transform: scale(.98); }
    .habit-card.s-full         { background: var(--green-bg);  border-color: var(--green);  }
    .habit-card.s-never-zero   { background: var(--orange-bg); border-color: var(--orange); }
    .habit-card.s-missed       { background: var(--grey-bg);   border-color: var(--grey); opacity: .75; }

    .hc-icon  { font-size: 26px; width: 34px; text-align: center; flex-shrink: 0; padding-top: 1px; }
    .hc-info  { flex: 1; min-width: 0; }
    .hc-name  { font-size: 15px; font-weight: 700; word-break: break-word; overflow-wrap: break-word; white-space: normal; line-height: 1.3; }
    .hc-sub   { font-size: 11px; margin-top: 3px; color: var(--muted); }

    .habit-card.s-full       .hc-sub { color: var(--green-txt); }
    .habit-card.s-never-zero .hc-sub { color: var(--orange-txt); }
    .habit-card.s-missed     .hc-sub { color: var(--grey-txt); }

    .hc-badge {
      width: 26px; height: 26px; border-radius: 50%;
      border: 2px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 800; color: #fff; flex-shrink: 0; margin-top: 3px;
    }
    .habit-card.s-full       .hc-badge { background: var(--green);  border-color: var(--green);  }
    .habit-card.s-never-zero .hc-badge { background: var(--orange); border-color: var(--orange); }
    .habit-card.s-missed     .hc-badge { background: var(--grey);   border-color: var(--grey);   }

    /* ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ */
    .month-nav {
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 18px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .month-nav-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: none; background: var(--bg);
      font-size: 20px; cursor: pointer; color: var(--text);
      display: flex; align-items: center; justify-content: center;
    }
    .month-nav-btn:active { opacity: .6; }
    .month-title { font-size: 16px; font-weight: 700; }

    .cal-scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 0 24px;
    }

    .cal-legend {
      display: flex; gap: 14px; flex-wrap: wrap;
      padding: 0 14px 12px;
    }
    .cal-leg-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted); }
    .cal-leg-dot  { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

    .cal-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }

    .cal-table { border-collapse: separate; border-spacing: 0; }

    .cal-label-cell {
      position: sticky; left: 0; z-index: 10;
      background: var(--bg);
      padding: 0 8px 0 14px;
      min-width: 76px; max-width: 76px;
      vertical-align: middle;
    }
    .cal-label-inner {
      display: flex; align-items: center; gap: 5px;
      font-size: 12px; font-weight: 600; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 68px;
    }
    .cal-label-icon { font-size: 14px; flex-shrink: 0; }

    .cal-header-row th { padding-bottom: 4px; }
    .cal-day-th {
      width: 36px; min-width: 36px;
      text-align: center; vertical-align: bottom;
    }
    .cal-day-num-hd { font-size: 11px; font-weight: 700; color: var(--muted); display: block; }
    .cal-day-wd-hd  { font-size: 9px;  font-weight: 500; color: #cbd5e1; display: block; }
    .cal-today-hd .cal-day-num-hd { color: var(--purple); }

    .cal-data-row td { padding: 2px; }
    .cal-cell {
      width: 30px; height: 30px; border-radius: 7px;
      cursor: pointer; transition: transform .1s;
      border: none; display: table-cell; vertical-align: middle; text-align: center;
      position: relative;
    }
    .cal-cell:active { transform: scale(.85); }
    .cal-cell.c-empty   { background: #f8fafc; border: 1.5px solid #e2e8f0; }
    .cal-cell.c-full    { background: var(--green);  }
    .cal-cell.c-nz      { background: var(--orange); }
    .cal-cell.c-missed  { background: var(--grey);   }
    .cal-cell.c-future  { background: transparent; cursor: default; border: 1.5px dashed #e2e8f0; opacity: .4; }
    .cal-cell.c-today-highlight { outline: 2px solid var(--purple); outline-offset: 1px; }

    .cal-jdi-row { background: var(--purple-bg); }
    .cal-jdi-cell {
      width: 30px; height: 30px; border-radius: 7px;
      font-size: 11px; font-weight: 800; color: var(--purple-txt);
      text-align: center; vertical-align: middle;
      cursor: pointer;
    }
    .cal-jdi-cell.c-has-jdi { background: var(--purple); color: #fff; }
    .cal-jdi-cell.c-future  { opacity: .3; cursor: default; }

    /* ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 400;
      background: rgba(15,23,42,.55);
      display: flex; align-items: flex-end;
      opacity: 0; pointer-events: none;
      transition: opacity .22s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }

    .modal-sheet {
      background: var(--card);
      border-radius: 24px 24px 0 0;
      padding: 0 0 env(safe-area-inset-bottom, 16px);
      width: 100%; max-width: 430px; margin: 0 auto;
      transform: translateY(100%);
      transition: transform .28s cubic-bezier(.32,1,.23,1);
      max-height: 85vh;
      display: flex; flex-direction: column;
    }
    .modal-overlay.open .modal-sheet { transform: translateY(0); }

    .modal-handle { width: 40px; height: 4px; border-radius: 2px; background: #cbd5e1; margin: 12px auto 0; flex-shrink: 0; }
    .modal-header { padding: 12px 20px 10px; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    .modal-date-title { font-size: 17px; font-weight: 800; }
    .modal-date-sub   { font-size: 12px; color: var(--muted); margin-top: 1px; }
    .modal-hint       { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .modal-body { flex: 1; overflow-y: auto; padding: 12px 16px 8px; }

    .modal-habit-row {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 14px; border-radius: 12px;
      margin-bottom: 7px; cursor: pointer;
      border: 2px solid transparent;
      transition: all .12s; user-select: none;
    }
    .modal-habit-row:active            { transform: scale(.97); }
    .modal-habit-row.s-full            { background: var(--green-bg);  border-color: var(--green);  }
    .modal-habit-row.s-never-zero      { background: var(--orange-bg); border-color: var(--orange); }
    .modal-habit-row.s-missed          { background: var(--grey-bg);   border-color: var(--grey); opacity: .8; }
    .modal-habit-row:not([class*="s-"]) { background: var(--bg); }

    .mhr-icon  { font-size: 22px; width: 30px; text-align: center; flex-shrink: 0; }
    .mhr-name  { flex: 1; font-size: 14px; font-weight: 600; min-width: 0; word-break: break-word; }
    .mhr-badge {
      font-size: 11px; font-weight: 700; padding: 3px 9px; border-radius: 20px;
      flex-shrink: 0; white-space: nowrap;
    }
    .s-full       .mhr-badge { background: var(--green);  color: #fff; }
    .s-never-zero .mhr-badge { background: var(--orange); color: #fff; }
    .s-missed     .mhr-badge { background: var(--grey);   color: #fff; }

    .modal-jdi-row {
      margin: 4px 0 8px;
      background: var(--purple-bg); border-radius: 12px;
      padding: 12px 14px;
      display: flex; align-items: center; gap: 10px;
    }
    .mjdi-label { flex: 1; font-size: 13px; font-weight: 700; color: var(--purple-txt); }
    .mjdi-controls { display: flex; align-items: center; gap: 8px; }
    .mjdi-count { font-size: 24px; font-weight: 900; color: var(--purple); min-width: 36px; text-align: center; }
    .mjdi-btn {
      width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer;
      font-size: 18px; font-weight: 800; display: flex; align-items: center; justify-content: center;
    }
    .mjdi-minus { background: #c7d2fe; color: var(--purple-txt); }
    .mjdi-plus  { background: var(--purple); color: #fff; }
    .mjdi-btn:active { transform: scale(.88); }

    .modal-footer { padding: 8px 16px 16px; flex-shrink: 0; }
    .modal-done {
      width: 100%; padding: 14px;
      background: var(--purple); color: #fff;
      border: none; border-radius: 13px;
      font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .modal-done:active { opacity: .88; }

    /* ‚îÄ‚îÄ SETTINGS VIEW ‚îÄ‚îÄ */
    .settings-scroll {
      flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding: 14px 14px 30px;
    }
    .settings-row {
      background: var(--card); border-radius: 13px;
      padding: 13px 14px; margin-bottom: 7px;
      display: flex; align-items: center; gap: 11px;
    }
    .settings-icon { font-size: 22px; width: 32px; text-align: center; flex-shrink: 0; }
    .settings-name { flex: 1; font-size: 14px; font-weight: 600; min-width: 0; word-break: break-word; }
    .del-btn {
      width: 30px; height: 30px; border-radius: 50%; border: none;
      background: #fee2e2; color: #ef4444;
      font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .del-btn:active { transform: scale(.88); }

    .add-form {
      background: var(--card); border-radius: var(--r);
      padding: 16px; margin-top: 12px;
    }
    .add-form-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 10px; }
    .form-row { display: flex; gap: 8px; margin-bottom: 9px; }

    .f-emoji {
      flex: 0 0 46px; width: 46px;
      padding: 11px 4px; text-align: center; font-size: 20px;
      border: 2px solid var(--border); border-radius: 11px;
      background: var(--bg); color: var(--text); outline: none; font-family: inherit;
    }
    .f-name {
      flex: 1; min-width: 0;
      padding: 11px 13px; font-size: 14px;
      border: 2px solid var(--border); border-radius: 11px;
      background: var(--bg); color: var(--text); outline: none; font-family: inherit;
    }
    .f-emoji:focus, .f-name:focus { border-color: var(--purple); }

    .btn-add {
      width: 100%; padding: 13px;
      background: var(--purple); color: #fff;
      border: none; border-radius: 12px;
      font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .btn-add:active { opacity: .88; }

    .legend-block { background: var(--card); border-radius: var(--r); padding: 16px; margin-top: 12px; }
    .leg-item { display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 5px 0; }
    .leg-dot  { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 14px; line-height: 1.7; }

    /* ‚îÄ‚îÄ JOURNAL VIEW ‚îÄ‚îÄ */
    .journal-view-wrap {
      flex: 1;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .journal-scroll {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 90px;
    }
    .journal-fab {
      position: absolute;
      bottom: 16px; right: 16px;
      background: var(--purple); color: #fff;
      border: none; border-radius: 28px;
      padding: 14px 22px;
      font-size: 15px; font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(99,102,241,.45);
      z-index: 50; font-family: inherit;
      transition: transform .1s;
    }
    .journal-fab:active { transform: scale(.95); }

    /* ‚îÄ‚îÄ ENTRY CARDS ‚îÄ‚îÄ */
    .entry-card {
      background: var(--card);
      border-radius: var(--r);
      padding: 14px 16px;
      margin-bottom: 9px;
      cursor: pointer;
      transition: transform .1s;
    }
    .entry-card:active { transform: scale(.98); }
    .entry-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }

    .entry-tag-pill {
      font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: .05em;
      padding: 3px 9px; border-radius: 20px;
    }
    .tag-ideas      { background: #dbeafe; color: #1d4ed8; }
    .tag-lessons    { background: var(--green-bg); color: var(--green-txt); }
    .tag-processing { background: var(--orange-bg); color: var(--orange-txt); }
    .tag-log        { background: var(--purple-bg); color: var(--purple-txt); }

    .entry-date    { font-size: 11px; color: var(--muted); margin-left: auto; }
    .entry-title   { font-size: 15px; font-weight: 700; margin-bottom: 3px; color: var(--text); }
    .entry-preview { font-size: 12px; color: var(--muted); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    /* ‚îÄ‚îÄ PROMPT SELECTION (Step 1) ‚îÄ‚îÄ */
    .prompt-list { padding: 8px 0; }
    .prompt-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 13px;
      padding: 14px 16px;
      margin-bottom: 9px;
      cursor: pointer;
      transition: all .12s;
      display: flex; align-items: center; gap: 12px;
    }
    .prompt-card:active { transform: scale(.97); }
    .prompt-emoji { font-size: 26px; flex-shrink: 0; }
    .prompt-text  { font-size: 15px; font-weight: 600; color: var(--text); }
    .prompt-tag   { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* ‚îÄ‚îÄ RECORDING SCREEN (Step 2) ‚îÄ‚îÄ */
    .step-header {
      display: flex; align-items: center;
      padding: 12px 16px 0; flex-shrink: 0;
    }
    .step-back {
      background: none; border: none; font-size: 28px;
      cursor: pointer; color: var(--muted);
      padding: 4px 8px; margin-left: -8px; line-height: 1;
    }
    .step-title  { font-size: 14px; font-weight: 700; flex: 1; text-align: center; color: var(--muted); }
    .step-spacer { width: 40px; }

    .record-prompt {
      font-size: 17px; font-weight: 700;
      color: var(--text); text-align: center;
      padding: 16px 20px 8px;
    }

    .lang-toggle {
      display: flex; gap: 6px; justify-content: center; margin-bottom: 12px;
    }
    .lang-btn {
      padding: 6px 14px; border-radius: 20px;
      border: 2px solid var(--border);
      background: var(--bg); color: var(--muted);
      font-size: 12px; font-weight: 700;
      cursor: pointer; font-family: inherit; transition: all .12s;
    }
    .lang-btn.active { background: var(--purple); color: #fff; border-color: var(--purple); }

    .record-area {
      flex: 1; overflow-y: auto;
      padding: 0 16px 12px;
    }

    .transcript-box {
      min-height: 120px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 13px;
      padding: 14px;
      font-size: 15px; line-height: 1.6;
      color: var(--text);
      margin-bottom: 10px;
      font-family: inherit;
      width: 100%; resize: none; outline: none;
    }
    .transcript-box:focus     { border-color: var(--purple); }
    .transcript-box.listening { border-color: #ef4444; }

    .record-hint { font-size: 12px; color: var(--muted); text-align: center; margin-bottom: 12px; }

    /* ‚îÄ‚îÄ DATE PICKER ROW ‚îÄ‚îÄ */
    .date-row {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg); border: 2px solid var(--border);
      border-radius: 12px; padding: 10px 14px;
      margin-bottom: 12px;
    }
    .date-row label { font-size: 12px; font-weight: 700; color: var(--muted); flex-shrink: 0; }
    .date-input {
      flex: 1; border: none; background: transparent;
      font-size: 14px; font-weight: 600; color: var(--text);
      font-family: inherit; outline: none; cursor: pointer;
    }

    /* ‚îÄ‚îÄ RECORD CONTROLS ‚îÄ‚îÄ */
    .record-controls { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 14px; }
    .record-btn {
      width: 72px; height: 72px; border-radius: 50%;
      border: none; cursor: pointer; font-size: 28px;
      display: flex; align-items: center; justify-content: center;
      background: #ef4444; color: #fff;
      transition: all .15s;
      box-shadow: 0 4px 16px rgba(239,68,68,.35);
    }
    .record-btn:active { transform: scale(.92); }
    .record-btn.recording { animation: pulse-rec 1.2s infinite; }
    .record-btn.paused { background: #f97316; box-shadow: 0 4px 16px rgba(249,115,22,.35); animation: none; }

    .stop-btn {
      width: 46px; height: 46px; border-radius: 50%;
      border: none; cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      background: #fee2e2; color: #ef4444;
      transition: all .15s;
    }
    .stop-btn:active { transform: scale(.92); }

    .field-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .field-lbl { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); flex: 1; }
    .field-mic-btn {
      width: 32px; height: 32px; border-radius: 50%;
      border: none; cursor: pointer; font-size: 14px;
      display: flex; align-items: center; justify-content: center;
      background: #ef4444; color: #fff;
      transition: all .15s; flex-shrink: 0;
    }
    .field-mic-btn:active { transform: scale(.92); }
    .field-mic-btn.recording { animation: pulse-rec 1.2s infinite; }
    .field-mic-btn.paused { background: #f97316; animation: none; }
    .title-input-box {
      width: 100%; box-sizing: border-box;
      border: 1.5px solid var(--border); border-radius: 10px;
      padding: 9px 12px; font-size: 15px; font-weight: 600;
      background: var(--bg); color: var(--text);
      outline: none; font-family: inherit; margin-bottom: 10px;
    }
    .title-input-box:focus { border-color: var(--purple); }
    .title-input-box.listening { border-color: #ef4444; }

    .tag-chips-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .entry-tag-chip {
      padding: 5px 13px; border-radius: 20px;
      font-size: 12px; font-weight: 700; cursor: pointer;
      border: 2px solid transparent;
      transition: opacity .15s, border-color .15s;
      opacity: 0.45;
    }
    .entry-tag-chip.active { opacity: 1; border-color: currentColor; }
    .entry-tag-chip:active { transform: scale(.95); }
    .prompt-input-box {
      width: 100%; box-sizing: border-box;
      border: 1.5px solid var(--border); border-radius: 10px;
      padding: 9px 12px; font-size: 14px; font-style: italic;
      background: var(--bg); color: var(--text);
      outline: none; font-family: inherit; margin-bottom: 12px;
    }
    .prompt-input-box:focus { border-color: var(--purple); }

    @keyframes pulse-rec {
      0%,100% { box-shadow: 0 4px 16px rgba(239,68,68,.4); }
      50%      { box-shadow: 0 4px 28px rgba(239,68,68,.8); transform: scale(1.05); }
    }

    .journal-save-btn {
      width: 100%; padding: 14px;
      background: var(--purple); color: #fff;
      border: none; border-radius: 13px;
      font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .journal-save-btn:active   { opacity: .88; }
    .journal-save-btn:disabled { opacity: .4; cursor: not-allowed; }

    /* ‚îÄ‚îÄ ENTRY DETAIL MODAL ‚îÄ‚îÄ */
    .detail-tag-wrap  { margin-bottom: 6px; }
    .detail-title     { font-size: 20px; font-weight: 800; margin-bottom: 4px; line-height: 1.3; }
    .detail-meta      { font-size: 12px; color: var(--muted); margin-bottom: 14px; }
    .detail-content   { font-size: 15px; line-height: 1.75; color: var(--text); white-space: pre-wrap; word-break: break-word; }
    .detail-actions   { display: flex; gap: 10px; margin-top: 18px; }
    .obsidian-btn {
      flex: 1; padding: 13px;
      background: #6b21a8; color: #fff;
      border: none; border-radius: 12px;
      font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .obsidian-btn:active { opacity: .88; }
    .del-entry-btn {
      padding: 13px 16px;
      background: #fee2e2; color: #ef4444;
      border: none; border-radius: 12px;
      font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .del-entry-btn:active { opacity: .88; }

    /* ‚îÄ‚îÄ EXPORTED BADGE ‚îÄ‚îÄ */
    .exported-badge {
      font-size: 10px; color: var(--muted);
      font-weight: 500; font-style: italic;
    }

    /* ‚îÄ‚îÄ SELECTION MODE ‚îÄ‚îÄ */
    .entry-card.selected {
      border: 2px solid var(--purple);
      background: var(--purple-bg);
    }
    .entry-card-check {
      width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0;
      border: 2px solid var(--border); background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; color: #fff; transition: all .15s; margin-top: 2px;
    }
    .entry-card.selected .entry-card-check { background: var(--purple); border-color: var(--purple); }

    .bulk-export-bar {
      position: absolute; bottom: 80px; left: 14px; right: 14px;
      background: var(--purple); color: #fff;
      border-radius: 14px; padding: 13px 18px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 20px rgba(99,102,241,.5); z-index: 60;
    }
    .bulk-count { font-size: 13px; font-weight: 700; }
    .bulk-export-btn {
      background: #fff; color: var(--purple);
      border: none; border-radius: 10px;
      padding: 8px 16px; font-size: 13px; font-weight: 800;
      cursor: pointer; font-family: inherit;
    }
    .bulk-export-btn:active { opacity: .85; }
    .bulk-cancel-btn {
      background: rgba(255,255,255,.2); color: #fff;
      border: none; border-radius: 10px;
      padding: 8px 12px; font-size: 13px; font-weight: 700;
      cursor: pointer; font-family: inherit;
    }
    .select-toggle-btn {
      background: var(--bg); border: 2px solid var(--border);
      border-radius: 20px; padding: 6px 14px;
      font-size: 13px; font-weight: 700; color: var(--muted);
      cursor: pointer; font-family: inherit; transition: all .12s;
    }
    .select-toggle-btn.active { background: var(--purple-bg); border-color: var(--purple); color: var(--purple-txt); }
    .select-toggle-btn:active { transform: scale(.96); }

    /* ‚îÄ‚îÄ SEARCH / FILTER PANEL ‚îÄ‚îÄ */
    .journal-toolbar {
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 14px 0;
    }
    .search-toggle-btn {
      background: var(--card); border: 2px solid var(--border);
      border-radius: 20px; padding: 6px 14px;
      font-size: 13px; font-weight: 700; color: var(--muted);
      cursor: pointer; font-family: inherit; transition: all .12s;
      display: flex; align-items: center; gap: 6px;
    }
    .search-toggle-btn.active { background: var(--purple-bg); border-color: var(--purple); color: var(--purple-txt); }
    .search-toggle-btn:active { transform: scale(.96); }

    .search-panel {
      flex-shrink: 0;
      padding: 10px 14px 6px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .search-input {
      width: 100%; padding: 10px 14px;
      border: 2px solid var(--border); border-radius: 11px;
      background: var(--bg); color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
      margin-bottom: 10px;
    }
    .search-input:focus { border-color: var(--purple); }

    .cat-tabs { display: flex; gap: 6px; margin-bottom: 10px; }
    .cat-tab {
      padding: 5px 12px; border-radius: 20px;
      border: 2px solid var(--border);
      background: var(--bg); color: var(--muted);
      font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit;
      transition: all .12s;
    }
    .cat-tab.active { background: var(--purple); color: #fff; border-color: var(--purple); }

    .tag-filter-chips { display: flex; flex-wrap: wrap; gap: 6px; padding-bottom: 4px; min-height: 0; }
    .filter-chip {
      padding: 4px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 700; cursor: pointer;
      border: 2px solid transparent; transition: all .12s;
      opacity: .75;
    }
    .filter-chip.active { opacity: 1; border-color: currentColor; }
    .filter-chip:active { transform: scale(.94); }

    /* ‚îÄ‚îÄ CUSTOM TAG PILLS ‚îÄ‚îÄ */
    .ctag-tags     { background: #dbeafe; color: #1d4ed8; }
    .ctag-topics   { background: #ccfbf1; color: #0f766e; }
    .ctag-people   { background: #fce7f3; color: #9d174d; }

    .custom-tags-row { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0 8px; min-height: 24px; }
    .ctag-pill {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 8px 3px 9px; border-radius: 20px;
      font-size: 11px; font-weight: 700;
    }
    .ctag-remove {
      background: none; border: none; cursor: pointer;
      font-size: 13px; line-height: 1; padding: 0;
      opacity: .6; font-family: inherit;
    }
    .ctag-remove:hover { opacity: 1; }

    .add-tag-row {
      display: flex; gap: 6px; align-items: center; margin-top: 8px;
    }
    .tag-cat-select {
      padding: 7px 8px; border: 2px solid var(--border); border-radius: 10px;
      background: var(--bg); color: var(--text);
      font-size: 12px; font-weight: 700; font-family: inherit; outline: none;
      cursor: pointer; flex-shrink: 0;
    }
    .tag-cat-select:focus { border-color: var(--purple); }
    .tag-label-input {
      flex: 1; min-width: 0; padding: 7px 11px;
      border: 2px solid var(--border); border-radius: 10px;
      background: var(--bg); color: var(--text);
      font-size: 13px; font-family: inherit; outline: none;
    }
    .tag-label-input:focus { border-color: var(--purple); }
    .tag-add-btn {
      width: 34px; height: 34px; border-radius: 50%;
      background: var(--purple); color: #fff;
      border: none; font-size: 20px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .tag-add-btn:active { transform: scale(.88); }

    .tags-section-lbl {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; color: var(--muted); margin-top: 14px;
    }

    /* ‚îÄ‚îÄ ENTRY DETAIL ACTIONS ‚îÄ‚îÄ */
    .detail-actions { display: flex; gap: 8px; margin-top: 16px; }
    .edit-entry-btn {
      padding: 12px 14px;
      background: var(--bg); color: var(--text);
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .edit-entry-btn:active { opacity: .85; }

    /* ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ */
    .edit-textarea {
      width: 100%; min-height: 160px;
      padding: 12px 14px; border: 2px solid var(--border); border-radius: 12px;
      background: var(--bg); color: var(--text);
      font-size: 15px; line-height: 1.65; font-family: inherit;
      outline: none; resize: none;
    }
    .edit-textarea:focus { border-color: var(--purple); }
    .edit-title-lbl { font-size: 11px; font-weight: 700; color: var(--muted); margin: 10px 0 4px; text-transform: uppercase; letter-spacing: .06em; }
    .edit-title-input {
      width: 100%; padding: 10px 13px;
      border: 2px solid var(--border); border-radius: 11px;
      background: var(--bg); color: var(--text);
      font-size: 14px; font-weight: 600; font-family: inherit; outline: none;
    }
    .edit-title-input:focus { border-color: var(--purple); }
    .edit-actions { display: flex; gap: 8px; margin-top: 14px; }
    .save-edit-btn {
      flex: 1; padding: 13px;
      background: var(--purple); color: #fff;
      border: none; border-radius: 12px;
      font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .save-edit-btn:active { opacity: .88; }
    .cancel-edit-btn {
      padding: 13px 16px;
      background: var(--bg); color: var(--muted);
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .cancel-edit-btn:active { opacity: .85; }

    /* ‚îÄ‚îÄ BACKUP / RESTORE ‚îÄ‚îÄ */
    .backup-block {
      background: var(--card); border-radius: var(--r);
      padding: 16px; margin-top: 12px;
    }
    .backup-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 10px; }
    .backup-row { display: flex; gap: 8px; }
    .btn-export {
      flex: 1; padding: 13px;
      background: #0f172a; color: #fff;
      border: none; border-radius: 12px;
      font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .btn-export:active { opacity: .85; }
    .btn-import {
      flex: 1; padding: 13px;
      background: var(--bg); color: var(--text);
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit;
    }
    .btn-import:active { opacity: .85; }
    .backup-hint { font-size: 11px; color: var(--muted); margin-top: 8px; line-height: 1.5; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="header-eye" id="hEye"></div>
    <div class="header-title" id="hTitle">Today</div>
  </div>

  <!-- APP -->
  <div id="app">

    <!-- TODAY VIEW -->
    <div class="view active" id="view-today">
      <div class="jdi-bar">
        <div class="jdi-bar-label">
          Just Do It
          <span>no-procrastination wins today</span>
        </div>
        <div class="jdi-controls">
          <button class="jdi-btn jdi-minus" onclick="adjJDI(-1)">‚àí</button>
          <div class="jdi-num" id="jdiNum">0</div>
          <button class="jdi-btn jdi-plus"  onclick="adjJDI(1)">+</button>
        </div>
      </div>
      <div class="summary-strip" id="summaryStrip"></div>
      <div class="today-scroll">
        <p class="tap-hint">Tap to cycle: Full ‚Üí Never Zero ‚Üí Missed ‚Üí Clear</p>
        <div class="section-lbl">Habits</div>
        <div id="habitList"></div>
      </div>
    </div>

    <!-- HISTORY / CALENDAR VIEW -->
    <div class="view" id="view-history">
      <div class="month-nav">
        <button class="month-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <div class="month-title" id="monthTitle"></div>
        <button class="month-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div class="cal-scroll-area">
        <div class="cal-legend">
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--green)"></div>Full</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--orange)"></div>Never Zero</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--grey)"></div>Missed</div>
          <div class="cal-leg-item"><div class="cal-leg-dot" style="background:var(--purple)"></div>JDI</div>
          <div class="cal-leg-item" style="color:#94a3b8;font-size:11px">Tap any day to edit</div>
        </div>
        <div class="cal-table-wrap">
          <table class="cal-table" id="calTable"></table>
        </div>
      </div>
    </div>

    <!-- JOURNAL VIEW -->
    <div class="view" id="view-journal">
      <div class="journal-view-wrap">
        <div class="journal-toolbar">
          <button class="select-toggle-btn" id="selectToggleBtn" onclick="toggleSelectionMode()">Select</button>
          <button class="search-toggle-btn" id="searchToggleBtn" onclick="toggleSearch()">üîç Search</button>
        </div>
        <div class="bulk-export-bar" id="bulkExportBar" style="display:none">
          <div class="bulk-count" id="bulkCount">0 selected</div>
          <div style="display:flex;gap:8px">
            <button class="bulk-cancel-btn" onclick="toggleSelectionMode()">Cancel</button>
            <button class="bulk-export-btn" onclick="exportSelected()">‚¨á Export ZIP</button>
          </div>
        </div>
        <div class="search-panel" id="searchPanel" style="display:none">
          <input type="text" class="search-input" id="searchInput" placeholder="Search‚Ä¶ use * as wildcard" oninput="applyFilters()">
          <div class="cat-tabs">
            <button class="cat-tab active" onclick="setCatFilter('all')">All</button>
            <button class="cat-tab" onclick="setCatFilter('tags')">Tags</button>
            <button class="cat-tab" onclick="setCatFilter('topics')">Topics</button>
            <button class="cat-tab" onclick="setCatFilter('people')">People</button>
          </div>
          <div class="tag-filter-chips" id="tagFilterChips"></div>
        </div>
        <div class="journal-scroll" id="journalList"></div>
        <button class="journal-fab" onclick="openNewEntry()">‚úèÔ∏è New Entry</button>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div class="view" id="view-settings">
      <div class="settings-scroll">
        <div class="section-lbl">My Habits</div>
        <div id="settingsList"></div>
        <div class="add-form">
          <div class="add-form-title">Add Habit</div>
          <div class="form-row">
            <input class="f-emoji" id="fEmoji" type="text" placeholder="üéØ" maxlength="2">
            <input class="f-name"  id="fName"  type="text" placeholder="Habit name...">
          </div>
          <button class="btn-add" onclick="addHabit()">Add Habit</button>
        </div>
        <div class="backup-block">
          <div class="backup-title">Backup & Restore</div>
          <div class="backup-row">
            <button class="btn-export" onclick="exportBackup()">‚¨á Export</button>
            <button class="btn-import" onclick="document.getElementById('importFile').click()">‚¨Ü Import</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
          </div>
          <div class="backup-hint">Export saves everything to your Files app. Import restores from a previous backup.</div>
        </div>

        <div class="legend-block">
          <div class="section-lbl" style="margin:0 0 8px">Legend</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--green)"></div><div><strong>Full</strong> ‚Äî Completed in full</div></div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--orange)"></div><div><strong>Never Zero</strong> ‚Äî Kept identity alive</div></div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--grey)"></div><div><strong>Missed</strong> ‚Äî Didn't happen today</div></div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--purple)"></div><div><strong>Just Do It</strong> ‚Äî No procrastination wins</div></div>
        </div>
      </div>
    </div>

  </div><!-- #app -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-btn active" id="nav-today"   onclick="go('today')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Today
    </button>
    <button class="nav-btn" id="nav-history" onclick="go('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Calendar
    </button>
    <button class="nav-btn" id="nav-journal" onclick="go('journal')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      Journal
    </button>
    <button class="nav-btn" id="nav-settings" onclick="go('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </button>
  </nav>

  <!-- EDIT MODAL (habits) -->
  <div class="modal-overlay" id="editModal" onclick="handleOverlayClick(event)">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-date-title" id="modalDateTitle"></div>
        <div class="modal-date-sub"   id="modalDateSub"></div>
        <div class="modal-hint">Tap a habit to cycle its status</div>
      </div>
      <div class="modal-body">
        <div id="modalHabits"></div>
        <div class="modal-jdi-row">
          <div class="mjdi-label">‚ö° Just Do It</div>
          <div class="mjdi-controls">
            <button class="mjdi-btn mjdi-minus" onclick="adjModalJDI(-1)">‚àí</button>
            <div class="mjdi-count" id="modalJdiCount">0</div>
            <button class="mjdi-btn mjdi-plus"  onclick="adjModalJDI(1)">+</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-done" onclick="closeModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- NEW ENTRY MODAL -->
  <div class="modal-overlay" id="newEntryModal">
    <div class="modal-sheet" style="max-height:92vh">
      <div class="modal-handle"></div>

      <!-- STEP 1: Prompt Selection -->
      <div id="journalStep1" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="modal-header">
          <div class="modal-date-title">New Journal Entry</div>
          <div class="modal-date-sub">What would you like to reflect on?</div>
        </div>
        <div class="modal-body">
          <div class="prompt-list" id="promptList"></div>
        </div>
        <div class="modal-footer">
          <button class="modal-done" style="background:var(--grey-txt)" onclick="closeNewEntry()">Cancel</button>
        </div>
      </div>

      <!-- STEP 2: Recording / Typing -->
      <div id="journalStep2" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="step-header">
          <button class="step-back" onclick="showStep(1)">‚Äπ</button>
          <div class="step-title">New Entry</div>
          <div class="step-spacer"></div>
        </div>
        <div class="lang-toggle">
          <button class="lang-btn active" id="langEN"  onclick="setLang('en-US')">üá∫üá∏ EN</button>
          <button class="lang-btn"        id="langFIL" onclick="setLang('fil-PH')">üáµüá≠ FIL</button>
        </div>
        <div class="record-area">
          <div class="field-row">
            <span class="field-lbl">Prompt</span>
          </div>
          <input class="prompt-input-box" id="entryPromptInput" type="text"
            placeholder="What are you reflecting on? (optional)">
          <div class="field-row" style="margin-bottom:4px">
            <span class="field-lbl">Tags</span>
          </div>
          <div class="custom-tags-row" id="creationTagsRow"></div>
          <div class="add-tag-row" style="margin-bottom:12px">
            <select class="tag-cat-select" id="creationTagCat">
              <option value="tags">Tag</option>
              <option value="topics">Topics</option>
              <option value="people">People</option>
            </select>
            <input class="tag-label-input" id="creationTagLabel" type="text"
              placeholder="Tag name‚Ä¶"
              onkeydown="if(event.key==='Enter')addCreationTag()">
            <button class="tag-add-btn" onclick="addCreationTag()">+</button>
          </div>
          <div class="date-row">
            <label>Date</label>
            <input type="date" class="date-input" id="entryDate">
          </div>
          <div class="field-row">
            <span class="field-lbl">Title</span>
            <button class="field-mic-btn idle" id="titleMicBtn" onclick="toggleRecording('title')" title="Dictate title">üéôÔ∏è</button>
          </div>
          <input class="title-input-box" id="titleInputBox" type="text"
            placeholder="Entry title (or dictate)‚Ä¶">
          <div class="field-row">
            <span class="field-lbl">Content</span>
            <button class="field-mic-btn idle" id="contentMicBtn" onclick="toggleRecording('content')" title="Dictate content">üéôÔ∏è</button>
          </div>
          <textarea class="transcript-box" id="transcriptBox"
            placeholder="Your words will appear here as you speak, or just type directly..."
            rows="5"
            oninput="onTranscriptInput()"></textarea>
          <div class="record-hint" id="recordHint">Tap a mic to start recording</div>
          <div class="record-controls">
            <button class="stop-btn" id="stopBtn" onclick="stopRecording()" style="display:none" title="Stop">‚èπ</button>
          </div>
        </div>
        <div style="padding:0 16px 16px;flex-shrink:0">
          <button class="journal-save-btn" id="saveEntryBtn" onclick="saveEntry()" disabled>Save Entry</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ENTRY DETAIL MODAL -->
  <div class="modal-overlay" id="entryDetailModal" onclick="handleDetailOverlayClick(event)">
    <div class="modal-sheet" style="max-height:92vh">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="detail-tag-wrap" id="detailTagWrap"></div>
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-meta"  id="detailMeta"></div>
      </div>
      <div class="modal-body">

        <!-- VIEW MODE -->
        <div id="entryViewMode">
          <div class="detail-content" id="detailContent"></div>

          <div class="tags-section-lbl">Tags</div>
          <div class="custom-tags-row" id="customTagsRow"></div>
          <div class="add-tag-row">
            <select class="tag-cat-select" id="tagCatSelect">
              <option value="tags">Tag</option>
              <option value="topics">Topic</option>
              <option value="people">Person</option>
            </select>
            <input class="tag-label-input" id="tagLabelInput" type="text"
              placeholder="Add label‚Ä¶"
              onkeydown="if(event.key==='Enter')addCustomTag()">
            <button class="tag-add-btn" onclick="addCustomTag()">+</button>
          </div>

          <div class="detail-actions">
            <button class="edit-entry-btn" onclick="enterEditMode()">‚úèÔ∏è Edit</button>
            <button class="obsidian-btn"   onclick="exportToObsidian()">‚¨á Obsidian</button>
            <button class="del-entry-btn"  onclick="deleteEntry()">üóë</button>
          </div>
        </div>

        <!-- EDIT MODE -->
        <div id="entryEditMode" style="display:none">
          <div class="edit-title-lbl">Content</div>
          <textarea class="edit-textarea" id="editTextarea"></textarea>
          <div class="edit-title-lbl">Title</div>
          <input class="edit-title-input" id="editTitleInput" type="text">
          <div class="edit-title-lbl">Date</div>
          <div class="date-row" style="margin-bottom:0">
            <label>üìÖ</label>
            <input type="date" class="date-input" id="editDateInput">
          </div>
          <div class="edit-actions">
            <button class="save-edit-btn"   onclick="saveEdit()">Save Changes</button>
            <button class="cancel-edit-btn" onclick="cancelEdit()">Cancel</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const JOURNAL_HABIT = { id: 'h-journal', icon: 'üìì', name: 'Journal', locked: true };

  const DEFAULT_HABITS = [
    JOURNAL_HABIT,
    { id: 'h-halt',      icon: 'üõë', name: 'Morning HALT Check' },
    { id: 'h-prayer',    icon: 'üôè', name: 'Morning Prayer' },
    { id: 'h-one-lever', icon: 'üéØ', name: 'One Lever ID' },
    { id: 'h-never-zero',icon: 'üî•', name: 'Never Zero' },
    { id: 'h-toddler',   icon: 'üë®‚Äçüë¶', name: 'Special Time (Toddler)' },
    { id: 'h-invisible', icon: 'üè†', name: 'Invisible Task Done' },
    { id: 'h-name-it',   icon: 'üè∑Ô∏è', name: 'Name It to Tame It' },
    { id: 'h-audit',     icon: 'üìã', name: 'Evening Audit' },
  ];

  const CYCLE = [null, 'full', 'never-zero', 'missed'];
  const STATUS_LABEL = { full: 'Full', 'never-zero': 'Never Zero', missed: 'Missed' };
  const STATUS_MARK  = { full: '‚úì', 'never-zero': '~', missed: '‚úï' };
  const STATUS_SUB   = {
    full:         'Full ‚Äî Completed',
    'never-zero': 'Never Zero ‚Äî Identity kept',
    missed:       'Missed',
  };

  let habits = load('habits', DEFAULT_HABITS);
  // Always ensure the locked Journal habit exists
  if (!habits.find(h => h.id === 'h-journal')) habits.unshift(JOURNAL_HABIT);
  let logs   = load('logs',   {});

  const today = new Date();
  let calYear  = today.getFullYear();
  let calMonth = today.getMonth();
  let modalDateKey = null;

  function load(k, fallback) {
    try { return JSON.parse(localStorage.getItem(k)) ?? fallback; }
    catch { return fallback; }
  }
  function persist() {
    localStorage.setItem('habits', JSON.stringify(habits));
    localStorage.setItem('logs',   JSON.stringify(logs));
  }
  function dateKey(y, m, d) {
    return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }
  function todayKey() { return dateKey(today.getFullYear(), today.getMonth(), today.getDate()); }
  function getLog(dk) {
    if (!logs[dk]) logs[dk] = { habits: {}, jdi: 0 };
    return logs[dk];
  }

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const VIEW_TITLES = { today: 'Today', history: 'Calendar', journal: 'Journal', settings: 'Settings' };

  function go(v) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + v).classList.add('active');
    document.getElementById('nav-' + v).classList.add('active');
    document.getElementById('hTitle').textContent = VIEW_TITLES[v];
    if (v === 'today')    renderToday();
    if (v === 'history')  renderCalendar();
    if (v === 'journal')  renderJournal();
    if (v === 'settings') renderSettings();
  }

  // ‚îÄ‚îÄ TODAY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderToday() {
    const log = getLog(todayKey());

    let full = 0, nz = 0, missed = 0;
    habits.forEach(h => {
      const s = log.habits[h.id];
      if (s === 'full') full++;
      else if (s === 'never-zero') nz++;
      else if (s === 'missed') missed++;
    });
    document.getElementById('summaryStrip').innerHTML = `
      <div class="s-pill sp-full">
        <div class="s-pill-num">${full}</div><div class="s-pill-lbl">Full</div>
      </div>
      <div class="s-pill sp-nz">
        <div class="s-pill-num">${nz}</div><div class="s-pill-lbl">Never Zero</div>
      </div>
      <div class="s-pill sp-missed">
        <div class="s-pill-num">${missed}</div><div class="s-pill-lbl">Missed</div>
      </div>`;

    const list = document.getElementById('habitList');
    list.innerHTML = habits.length
      ? habits.map(h => {
          const s = log.habits[h.id] || null;
          return `
            <div class="habit-card ${s ? 's-'+s : ''}" onclick="cycleHabit('${h.id}')">
              <div class="hc-icon">${h.icon}</div>
              <div class="hc-info">
                <div class="hc-name">${h.name}</div>
                <div class="hc-sub">${s ? STATUS_SUB[s] : 'Not logged ‚Äî tap to set'}</div>
              </div>
              <div class="hc-badge">${s ? STATUS_MARK[s] : ''}</div>
            </div>`;
        }).join('')
      : '<div class="empty">No habits yet.<br>Add some in Settings.</div>';

    document.getElementById('jdiNum').textContent = log.jdi || 0;
  }

  function cycleHabit(id) {
    const log = getLog(todayKey());
    const cur  = log.habits[id] || null;
    const next = CYCLE[(CYCLE.indexOf(cur) + 1) % CYCLE.length];
    if (next === null) delete log.habits[id];
    else log.habits[id] = next;
    persist();
    renderToday();
  }

  function adjJDI(delta) {
    const log = getLog(todayKey());
    log.jdi = Math.max(0, (log.jdi || 0) + delta);
    persist();
    document.getElementById('jdiNum').textContent = log.jdi;
  }

  // ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function changeMonth(delta) {
    calMonth += delta;
    if (calMonth > 11) { calMonth = 0;  calYear++; }
    if (calMonth < 0)  { calMonth = 11; calYear--; }
    renderCalendar();
  }

  function renderCalendar() {
    const monthNames = ['January','February','March','April','May','June',
                        'July','August','September','October','November','December'];
    const dayLetters = ['S','M','T','W','T','F','S'];
    document.getElementById('monthTitle').textContent = `${monthNames[calMonth]} ${calYear}`;

    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
    const todK = todayKey();

    const table = document.getElementById('calTable');
    let html = '<thead><tr class="cal-header-row">';
    html += `<th class="cal-label-cell" style="background:var(--bg)"></th>`;

    for (let d = 1; d <= daysInMonth; d++) {
      const dk   = dateKey(calYear, calMonth, d);
      const dow  = new Date(calYear, calMonth, d).getDay();
      const isTd = dk === todK;
      html += `<th class="cal-day-th ${isTd ? 'cal-today-hd' : ''}">
        <span class="cal-day-num-hd">${d}</span>
        <span class="cal-day-wd-hd">${dayLetters[dow]}</span>
      </th>`;
    }
    html += '</tr></thead><tbody>';

    habits.forEach(h => {
      html += `<tr class="cal-data-row">
        <td class="cal-label-cell">
          <div class="cal-label-inner">
            <span class="cal-label-icon">${h.icon}</span>
            <span>${h.name}</span>
          </div>
        </td>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const dk     = dateKey(calYear, calMonth, d);
        const isFut  = dk > todK;
        const s      = logs[dk]?.habits?.[h.id] || null;
        const cls    = isFut ? 'c-future' : (s ? 'c-'+s.replace('never-zero','nz') : 'c-empty');
        const tdCls  = dk === todK ? 'cal-cell-today' : '';
        html += `<td style="padding:2px">
          <div class="cal-cell ${cls} ${tdCls}" onclick="${isFut ? '' : `openModal('${dk}')`}" title="${dk}"></div>
        </td>`;
      }
      html += '</tr>';
    });

    html += `<tr class="cal-data-row cal-jdi-row">
      <td class="cal-label-cell" style="background:var(--purple-bg)">
        <div class="cal-label-inner" style="color:var(--purple-txt)">
          <span class="cal-label-icon">‚ö°</span><span>JDI</span>
        </div>
      </td>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const dk    = dateKey(calYear, calMonth, d);
      const isFut = dk > todK;
      const jdi   = logs[dk]?.jdi || 0;
      const cls   = isFut ? 'c-future' : (jdi > 0 ? 'c-has-jdi' : '');
      html += `<td style="padding:2px">
        <div class="cal-jdi-cell ${cls}" onclick="${isFut ? '' : `openModal('${dk}')`}">
          ${!isFut && jdi > 0 ? jdi : (isFut ? '' : '¬∑')}
        </div>
      </td>`;
    }
    html += '</tr></tbody>';
    table.innerHTML = html;

    const wrap = document.querySelector('.cal-table-wrap');
    if (calYear === today.getFullYear() && calMonth === today.getMonth()) {
      const cellW = 36;
      const d = today.getDate();
      const offset = Math.max(0, (d - 4) * cellW);
      setTimeout(() => { wrap.scrollLeft = offset; }, 50);
    } else {
      wrap.scrollLeft = 0;
    }
  }

  // ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openModal(dk) {
    modalDateKey = dk;
    const log = getLog(dk);
    const d   = new Date(dk + 'T12:00:00');
    const dayName = d.toLocaleDateString('en-AU', { weekday: 'long' });
    const dateStr = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });

    document.getElementById('modalDateTitle').textContent = dayName;
    document.getElementById('modalDateSub').textContent   = dateStr;

    renderModalHabits();
    document.getElementById('modalJdiCount').textContent = log.jdi || 0;

    const overlay = document.getElementById('editModal');
    overlay.style.display = 'flex';
    requestAnimationFrame(() => overlay.classList.add('open'));
  }

  function renderModalHabits() {
    const log = getLog(modalDateKey);
    document.getElementById('modalHabits').innerHTML = habits.map(h => {
      const s = log.habits[h.id] || null;
      return `
        <div class="modal-habit-row ${s ? 's-'+s : ''}" onclick="cycleModalHabit('${h.id}')">
          <div class="mhr-icon">${h.icon}</div>
          <div class="mhr-name">${h.name}</div>
          <div class="mhr-badge">${s ? STATUS_LABEL[s] : '‚Äî'}</div>
        </div>`;
    }).join('');
  }

  function cycleModalHabit(id) {
    const log = getLog(modalDateKey);
    const cur  = log.habits[id] || null;
    const next = CYCLE[(CYCLE.indexOf(cur) + 1) % CYCLE.length];
    if (next === null) delete log.habits[id];
    else log.habits[id] = next;
    persist();
    renderModalHabits();
  }

  function adjModalJDI(delta) {
    const log = getLog(modalDateKey);
    log.jdi = Math.max(0, (log.jdi || 0) + delta);
    persist();
    document.getElementById('modalJdiCount').textContent = log.jdi;
  }

  function closeModal() {
    const overlay = document.getElementById('editModal');
    overlay.classList.remove('open');
    overlay.addEventListener('transitionend', () => {
      overlay.style.display = 'none';
      if (document.getElementById('view-history').classList.contains('active')) renderCalendar();
      if (document.getElementById('view-today').classList.contains('active'))   renderToday();
    }, { once: true });
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('editModal')) closeModal();
  }

  // ‚îÄ‚îÄ SETTINGS VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSettings() {
    document.getElementById('settingsList').innerHTML = habits.length
      ? habits.map(h => `
          <div class="settings-row">
            <div class="settings-icon">${h.icon}</div>
            <div class="settings-name">${h.name}${h.locked ? ' <span style="font-size:10px;color:var(--muted);font-weight:500">auto-tracked</span>' : ''}</div>
            ${h.locked
              ? '<div style="font-size:16px;color:var(--muted);padding:0 4px">üîí</div>'
              : `<button class="del-btn" onclick="removeHabit('${h.id}')">√ó</button>`}
          </div>`).join('')
      : '<div class="empty">No habits yet.</div>';
  }

  function addHabit() {
    const icon = document.getElementById('fEmoji').value.trim() || 'üéØ';
    const name = document.getElementById('fName').value.trim();
    if (!name) { document.getElementById('fName').focus(); return; }
    habits.push({ id: 'h' + Date.now(), icon, name });
    persist();
    document.getElementById('fEmoji').value = '';
    document.getElementById('fName').value  = '';
    renderSettings();
  }

  function removeHabit(id) {
    if (id === 'h-journal') return;
    if (!confirm('Remove this habit?')) return;
    habits = habits.filter(h => h.id !== id);
    persist();
    renderSettings();
  }

  // ‚îÄ‚îÄ BACKUP & RESTORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportBackup() {
    const data = {
      exported: new Date().toISOString().slice(0, 10),
      version:  1,
      habits:   habits,
      logs:     logs,
      journal:  journal,
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `habits-backup-${data.exported}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.habits || !data.logs) { alert('Invalid backup file.'); return; }
        if (!confirm('This will replace all current data with the backup. Continue?')) return;
        habits  = data.habits;
        logs    = data.logs;
        journal = data.journal || [];
        // Ensure locked journal habit is always present
        if (!habits.find(h => h.id === 'h-journal')) habits.unshift(JOURNAL_HABIT);
        persist();
        localStorage.setItem('journal', JSON.stringify(journal));
        renderSettings();
        alert('Backup restored successfully.');
      } catch {
        alert('Could not read backup file. Make sure it is a valid backup.');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  // ‚îÄ‚îÄ JOURNAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const TAGS = [
    { id: 'ideas',      label: 'Ideas',      css: 'tag-ideas'      },
    { id: 'lessons',    label: 'Lessons',    css: 'tag-lessons'    },
    { id: 'processing', label: 'Processing', css: 'tag-processing' },
    { id: 'log',        label: 'Log',        css: 'tag-log'        },
  ];

  const PROMPTS = [
    { emoji: 'üí≠', text: 'What are you thinking?',                    tag: 'ideas'      },
    { emoji: 'üìö', text: 'What have you learned today?',              tag: 'lessons'    },
    { emoji: 'üí¨', text: 'What happened?',                            tag: 'processing' },
    { emoji: 'üìÖ', text: 'Tell me something about today.',            tag: 'log'        },
    { emoji: '‚≠ê', text: "What's the best thing that happened today?", tag: 'log'        },
  ];

  let journal         = load('journal', []);
  let activePromptIdx = null;
  let currentLang     = 'en-US';
  let recognition          = null;
  let isRecording          = false;
  let isPaused             = false;
  let baseText             = '';
  let activeRecordTarget   = 'content'; // 'title' or 'content'
  let creationTags         = [];        // tags added during entry creation
  let currentDetailId = null;
  let filterText      = '';
  let filterCategory  = 'all';
  let filterTagLabel  = null;
  let showSearch      = false;
  let selectionMode   = false;
  let selectedIds     = new Set();

  function wildcardRegex(pattern) {
    const escaped = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
    return new RegExp(escaped.replace(/\*/g, '.*'), 'i');
  }

  function allTagsFor(entry) {
    const baseTag = entry.tag || (entry.tagLabel ? entry.tagLabel.replace(/^\[|\]$/g, '') : null);
    return [
      ...(baseTag ? [{ label: baseTag, category: 'tags' }] : []),
      ...(entry.customTags || []),
    ];
  }

  function getFilteredEntries() {
    let entries = [...journal].sort((a, b) => b.timestamp - a.timestamp);
    if (filterText.trim()) {
      try {
        const rx = wildcardRegex(filterText.trim());
        entries = entries.filter(e => rx.test(e.title) || rx.test(e.content));
      } catch { /* invalid regex ‚Äî skip */ }
    }
    if (filterTagLabel) {
      entries = entries.filter(e => allTagsFor(e).some(t => {
        const catMatch = filterCategory === 'all' || t.category === filterCategory;
        return catMatch && t.label === filterTagLabel;
      }));
    } else if (filterCategory !== 'all') {
      entries = entries.filter(e => (e.customTags || []).some(t => t.category === filterCategory));
    }
    return entries;
  }

  function renderTagFilterChips() {
    const seen = new Set();
    const chips = [];
    journal.forEach(e => {
      allTagsFor(e).forEach(t => {
        if (filterCategory !== 'all' && t.category !== filterCategory) return;
        if (!seen.has(t.label)) {
          seen.add(t.label);
          chips.push(t);
        }
      });
    });
    const container = document.getElementById('tagFilterChips');
    if (!container) return;
    container.innerHTML = chips.map(t => {
      const cls   = `ctag-${t.category}`;
      const active = filterTagLabel === t.label ? 'active' : '';
      return `<span class="filter-chip ${cls} ${active}" onclick="setTagFilter('${escHtml(t.label)}')">${escHtml(t.label)}</span>`;
    }).join('');
  }

  function renderJournal() {
    renderTagFilterChips();
    const list    = document.getElementById('journalList');
    const entries = getFilteredEntries();
    if (!journal.length) {
      list.innerHTML = '<div class="empty">No entries yet.<br>Tap <strong>‚úèÔ∏è New Entry</strong> to start.</div>';
      return;
    }
    if (!entries.length) {
      list.innerHTML = '<div class="empty">No entries match your filters.</div>';
      return;
    }
    list.innerHTML = entries.map(e => {
      const customPills  = (e.customTags || []).map(t =>
        `<span class="entry-tag-pill ctag-${t.category}">${escHtml(t.label)}</span>`
      ).join('');
      const isSelected   = selectedIds.has(e.id);
      const selectedCls  = isSelected ? 'selected' : '';
      const clickFn      = selectionMode ? `toggleSelectEntry('${e.id}')` : `openEntry('${e.id}')`;
      const checkHtml    = selectionMode
        ? `<div class="entry-card-check">${isSelected ? '‚úì' : ''}</div>` : '';
      const exportedBadge = e.exported
        ? '<span class="exported-badge"> ¬∑ exported</span>' : '';
      const innerStyle   = selectionMode ? 'style="flex:1;min-width:0"' : '';
      const cardStyle    = selectionMode ? 'style="display:flex;align-items:flex-start;gap:10px"' : '';
      return `
        <div class="entry-card ${selectedCls}" onclick="${clickFn}" ${cardStyle}>
          ${checkHtml}
          <div ${innerStyle}>
            <div class="entry-card-top">
              ${e.tag ? `<span class="entry-tag-pill tag-${e.tag}">${escHtml(TAGS.find(t=>t.id===e.tag)?.label || e.tag)}</span>` : ''}
              ${customPills}
              <span class="entry-date">${formatEntryDate(e.date)}${exportedBadge}</span>
            </div>
            <div class="entry-title">${escHtml(e.title)}</div>
            <div class="entry-preview">${escHtml(e.content)}</div>
          </div>
        </div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ SEARCH & FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleSearch() {
    showSearch = !showSearch;
    const panel = document.getElementById('searchPanel');
    const btn   = document.getElementById('searchToggleBtn');
    panel.style.display = showSearch ? 'block' : 'none';
    btn.classList.toggle('active', showSearch);
    if (!showSearch) {
      filterText = ''; filterTagLabel = null; filterCategory = 'all';
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('.cat-tab').forEach((t,i) => t.classList.toggle('active', i===0));
      renderJournal();
    }
  }

  function applyFilters() {
    filterText = document.getElementById('searchInput').value;
    renderJournal();
  }

  function setCatFilter(cat) {
    filterCategory = cat;
    filterTagLabel = null;
    document.querySelectorAll('.cat-tab').forEach(t => {
      t.classList.toggle('active', t.textContent.toLowerCase() === cat || (cat === 'all' && t.textContent === 'All'));
    });
    renderJournal();
  }

  function setTagFilter(label) {
    filterTagLabel = filterTagLabel === label ? null : label;
    renderJournal();
  }

  // ‚îÄ‚îÄ SELECTION MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleSelectionMode() {
    selectionMode = !selectionMode;
    selectedIds.clear();
    const btn = document.getElementById('selectToggleBtn');
    const bar = document.getElementById('bulkExportBar');
    btn.classList.toggle('active', selectionMode);
    btn.textContent = selectionMode ? 'Cancel' : 'Select';
    bar.style.display = 'none';
    renderJournal();
  }

  function toggleSelectEntry(id) {
    if (selectedIds.has(id)) selectedIds.delete(id);
    else selectedIds.add(id);
    const bar = document.getElementById('bulkExportBar');
    const cnt = document.getElementById('bulkCount');
    bar.style.display = selectedIds.size ? 'flex' : 'none';
    cnt.textContent   = `${selectedIds.size} selected`;
    renderJournal();
  }

  // ‚îÄ‚îÄ EXPORT HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function sanitizeFilename(str) {
    return str.replace(/[\/\\:*?"<>|]/g, '-').replace(/\s+/g, ' ').trim().slice(0, 100);
  }

  function generateMd(entry) {
    const customTags = (entry.customTags || []);
    const baseTag    = entry.tag || (entry.tagLabel ? entry.tagLabel.replace(/^\[|\]$/g, '') : null);
    const tagLine    = [baseTag, ...customTags.map(t => t.label)].filter(Boolean).join(', ');
    const peopleLine = customTags.filter(t => t.category === 'people').map(t => t.label).join(', ');
    const topicsLine = customTags.filter(t => t.category === 'topics').map(t => t.label).join(', ');
    const inlineTags = [baseTag ? `[${baseTag}]` : null, ...customTags.map(t => `[${t.label}]`)].filter(Boolean).join(' ');
    return `---
title: "${entry.title.replace(/"/g, "'")}"
date: ${entry.date}
tags: [${tagLine}]${peopleLine ? `\npeople: [${peopleLine}]` : ''}${topicsLine ? `\ntopics: [${topicsLine}]` : ''}
prompt: "${entry.prompt}"
source: Voice Journal
---

${inlineTags}

${entry.content}
`;
  }

  async function exportSelected() {
    const entries = [...selectedIds]
      .map(id => journal.find(e => e.id === id))
      .filter(Boolean);
    if (!entries.length) return;

    if (window.JSZip) {
      const zip    = new JSZip();
      const folder = zip.folder('journal-export');
      entries.forEach(entry => {
        folder.file(sanitizeFilename(entry.title) + '.md', generateMd(entry));
        entry.exported = true;
      });
      localStorage.setItem('journal', JSON.stringify(journal));
      const blob = await zip.generateAsync({ type: 'blob' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `journal-export-${todayKey()}.zip`;
      a.click();
      URL.revokeObjectURL(url);
    } else {
      // Fallback: sequential downloads with delay
      for (let i = 0; i < entries.length; i++) {
        await new Promise(r => setTimeout(r, i * 500));
        const entry = entries[i];
        const blob  = new Blob([generateMd(entry)], { type: 'text/markdown' });
        const url   = URL.createObjectURL(blob);
        const a     = document.createElement('a');
        a.href      = url;
        a.download  = sanitizeFilename(entry.title) + '.md';
        a.click();
        URL.revokeObjectURL(url);
        entry.exported = true;
      }
      localStorage.setItem('journal', JSON.stringify(journal));
    }

    toggleSelectionMode();
    renderJournal();
  }

  function formatEntryDate(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function generateTitle(text) {
    if (!text.trim()) return 'Untitled entry';
    const sentence = text.match(/^[^.!?\n]+[.!?]/);
    if (sentence && sentence[0].length < 80) return sentence[0].trim();
    const words = text.trim().split(/\s+/);
    return words.slice(0, 10).join(' ') + (words.length > 10 ? '...' : '');
  }

  // ‚îÄ‚îÄ NEW ENTRY FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openNewEntry() {
    showStep(1);
    const modal = document.getElementById('newEntryModal');
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('open'));
  }

  function closeNewEntry() {
    stopRecording();
    const modal = document.getElementById('newEntryModal');
    modal.classList.remove('open');
    modal.addEventListener('transitionend', () => { modal.style.display = 'none'; }, { once: true });
  }

  function showStep(n) {
    const s1 = document.getElementById('journalStep1');
    const s2 = document.getElementById('journalStep2');
    s1.style.display = n === 1 ? 'flex' : 'none';
    s2.style.display = n === 2 ? 'flex' : 'none';

    if (n === 1) {
      stopRecording();
      const promptCards = PROMPTS.map((p, i) => {
        const tagObj = TAGS.find(t => t.id === p.tag);
        const tagDisplay = tagObj ? tagObj.label : p.tag;
        return `
          <div class="prompt-card" onclick="selectPrompt(${i})">
            <div class="prompt-emoji">${p.emoji}</div>
            <div>
              <div class="prompt-text">${p.text}</div>
              <div class="prompt-tag">${tagDisplay}</div>
            </div>
          </div>`;
      });
      const customCard = `
        <div class="prompt-card" onclick="selectBlankEntry()">
          <div class="prompt-emoji">‚úçÔ∏è</div>
          <div>
            <div class="prompt-text">Custom entry</div>
            <div class="prompt-tag">Write your own prompt ¬∑ tag optional</div>
          </div>
        </div>`;
      document.getElementById('promptList').innerHTML = [...promptCards, customCard].join('');
    }
  }

  function resetStep2Fields() {
    creationTags = [];
    document.getElementById('creationTagsRow').innerHTML = '';
    document.getElementById('creationTagLabel').value    = '';
    document.getElementById('transcriptBox').value       = '';
    document.getElementById('titleInputBox').value       = '';
    document.getElementById('saveEntryBtn').disabled     = true;
    document.getElementById('recordHint').textContent    = 'Tap a mic to start recording';
    document.getElementById('titleMicBtn').className     = 'field-mic-btn idle';
    document.getElementById('titleMicBtn').textContent   = 'üéôÔ∏è';
    document.getElementById('contentMicBtn').className   = 'field-mic-btn idle';
    document.getElementById('contentMicBtn').textContent = 'üéôÔ∏è';
    document.getElementById('stopBtn').style.display     = 'none';
    document.getElementById('entryDate').value           = todayKey();
    document.getElementById('entryDate').max             = todayKey();
    baseText = '';
    isPaused = false;
  }

  function renderCreationTags() {
    const row = document.getElementById('creationTagsRow');
    row.innerHTML = creationTags.map((t, i) =>
      `<span class="ctag-pill ctag-${t.category}">
        ${escHtml(t.label)}
        <button class="ctag-remove" onclick="removeCreationTag(${i})">√ó</button>
      </span>`
    ).join('');
  }

  function addCreationTag() {
    const label = document.getElementById('creationTagLabel').value.trim();
    if (!label) return;
    const cat = document.getElementById('creationTagCat').value;
    if (creationTags.some(t => t.label === label && t.category === cat)) {
      document.getElementById('creationTagLabel').value = '';
      return;
    }
    creationTags.push({ label, category: cat });
    document.getElementById('creationTagLabel').value = '';
    renderCreationTags();
  }

  function removeCreationTag(idx) {
    creationTags.splice(idx, 1);
    renderCreationTags();
  }

  function selectPrompt(idx) {
    activePromptIdx = idx;
    const p = PROMPTS[idx];
    document.getElementById('entryPromptInput').value = p.text;
    resetStep2Fields();
    // Pre-add the prompt's standard tag
    if (p.tag) {
      creationTags.push({ label: p.tag, category: 'tags' });
      renderCreationTags();
    }
    showStep(2);
  }

  function selectBlankEntry() {
    activePromptIdx = null;
    document.getElementById('entryPromptInput').value = '';
    resetStep2Fields();
    showStep(2);
  }

  // ‚îÄ‚îÄ SPEECH RECOGNITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setLang(lang) {
    currentLang = lang;
    document.getElementById('langEN').classList.toggle('active',  lang === 'en-US');
    document.getElementById('langFIL').classList.toggle('active', lang === 'fil-PH');
    if (isRecording) { stopRecording(); setTimeout(startRecording, 300); }
  }

  function toggleRecording(target) {
    if (isRecording) {
      if (activeRecordTarget === target) {
        pauseRecording();
      } else {
        // Switch target: stop current then start new
        stopRecording();
        activeRecordTarget = target;
        startRecording();
      }
    } else {
      activeRecordTarget = target;
      startRecording();
    }
  }

  function startRecording() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      document.getElementById('recordHint').textContent = 'Speech not supported on this browser. Please type your entry.';
      return;
    }
    const isTitle  = activeRecordTarget === 'title';
    const fieldEl  = document.getElementById(isTitle ? 'titleInputBox' : 'transcriptBox');
    const micBtnId = isTitle ? 'titleMicBtn' : 'contentMicBtn';
    // Sync baseText with whatever is in the field (handles manual edits while paused)
    baseText = fieldEl.value;

    recognition = new SR();
    recognition.lang = currentLang;
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = (e) => {
      let interim = '', finalChunk = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) finalChunk += e.results[i][0].transcript + ' ';
        else interim += e.results[i][0].transcript;
      }
      baseText += finalChunk;
      fieldEl.value = baseText + interim;
      updateSaveBtn();
    };

    recognition.onerror = (e) => {
      document.getElementById('recordHint').textContent = 'Mic error: ' + e.error + '. Try typing instead.';
      stopRecording();
    };

    recognition.onend = () => { if (isRecording) recognition.start(); };

    recognition.start();
    isRecording = true;
    isPaused    = false;
    document.getElementById(micBtnId).className   = 'field-mic-btn recording';
    document.getElementById(micBtnId).textContent = '‚è∏';
    document.getElementById('stopBtn').style.display  = 'flex';
    document.getElementById('recordHint').textContent = 'Recording ' + (isTitle ? 'title' : 'content') + '‚Ä¶ tap to pause';
    fieldEl.classList.add('listening');
  }

  function pauseRecording() {
    if (recognition) {
      recognition.onend = null;
      try { recognition.stop(); } catch {}
      recognition = null;
    }
    const isTitle  = activeRecordTarget === 'title';
    const fieldEl  = document.getElementById(isTitle ? 'titleInputBox' : 'transcriptBox');
    const micBtnId = isTitle ? 'titleMicBtn' : 'contentMicBtn';
    // Sync baseText so resume picks up clean text
    baseText = fieldEl.value;
    isRecording = false;
    isPaused    = true;
    document.getElementById(micBtnId).className   = 'field-mic-btn paused';
    document.getElementById(micBtnId).textContent = '‚ñ∂';
    document.getElementById('recordHint').textContent = 'Paused ‚Äî tap to resume';
    fieldEl.classList.remove('listening');
  }

  function stopRecording() {
    if (recognition) {
      recognition.onend = null;
      try { recognition.stop(); } catch {}
      recognition = null;
    }
    isRecording = false;
    isPaused    = false;
    baseText    = '';
    const titleBtn = document.getElementById('titleMicBtn');
    if (titleBtn) { titleBtn.className = 'field-mic-btn idle'; titleBtn.textContent = 'üéôÔ∏è'; }
    const contentBtn = document.getElementById('contentMicBtn');
    if (contentBtn) { contentBtn.className = 'field-mic-btn idle'; contentBtn.textContent = 'üéôÔ∏è'; }
    const stop = document.getElementById('stopBtn');
    if (stop) stop.style.display = 'none';
    const hint = document.getElementById('recordHint');
    if (hint) hint.textContent = 'Tap a mic to start recording';
    const box = document.getElementById('transcriptBox');
    if (box) box.classList.remove('listening');
    const titleBox = document.getElementById('titleInputBox');
    if (titleBox) titleBox.classList.remove('listening');
  }

  function updateSaveBtn() {
    const content = document.getElementById('transcriptBox').value.trim();
    document.getElementById('saveEntryBtn').disabled = !content;
  }

  function onTranscriptInput() { updateSaveBtn(); }

  function saveEntry() {
    const content   = document.getElementById('transcriptBox').value.trim();
    if (!content) return;
    const rawTitle  = document.getElementById('titleInputBox').value.trim();
    const entryDate = document.getElementById('entryDate').value || todayKey();
    const entryPrompt = document.getElementById('entryPromptInput').value.trim();
    const stdTagIds   = TAGS.map(t => t.id);
    const stdTagEntry = creationTags.find(t => t.category === 'tags' && stdTagIds.includes(t.label.toLowerCase()));
    const entry = {
      id:         'j' + Date.now(),
      timestamp:  Date.now(),
      date:       entryDate,
      prompt:     entryPrompt,
      tag:        stdTagEntry ? stdTagEntry.label.toLowerCase() : null,
      title:      rawTitle || generateTitle(content),
      content,
      customTags: stdTagEntry ? creationTags.filter(t => t !== stdTagEntry) : [...creationTags],
    };
    journal.unshift(entry);
    localStorage.setItem('journal', JSON.stringify(journal));

    // Auto-tick the Journal habit for the entry's date
    const entryLog = getLog(entryDate);
    entryLog.habits['h-journal'] = 'full';
    persist();

    stopRecording();
    closeNewEntry();
    renderJournal();
  }

  // ‚îÄ‚îÄ ENTRY DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openEntry(id) {
    const entry = journal.find(e => e.id === id);
    if (!entry) return;
    currentDetailId = id;

    document.getElementById('entryViewMode').style.display = '';
    document.getElementById('entryEditMode').style.display = 'none';

    const tagObj = TAGS.find(t => t.id === entry.tag);
    const tagDisplay = tagObj ? tagObj.label : (entry.tag || '');
    document.getElementById('detailTagWrap').innerHTML = entry.tag
      ? `<span class="entry-tag-pill tag-${entry.tag}">${escHtml(tagDisplay)}</span>` : '';
    document.getElementById('detailTitle').textContent   = entry.title;
    document.getElementById('detailMeta').textContent    = formatEntryDate(entry.date) + ' ¬∑ ' + entry.prompt;
    document.getElementById('detailContent').textContent = entry.content;
    document.getElementById('tagLabelInput').value = '';
    renderDetailTags();

    const modal = document.getElementById('entryDetailModal');
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('open'));
  }

  function closeEntryDetail() {
    const modal = document.getElementById('entryDetailModal');
    modal.classList.remove('open');
    modal.addEventListener('transitionend', () => { modal.style.display = 'none'; }, { once: true });
  }

  function handleDetailOverlayClick(e) {
    if (e.target === document.getElementById('entryDetailModal')) closeEntryDetail();
  }

  function deleteEntry() {
    if (!confirm('Delete this entry?')) return;
    journal = journal.filter(e => e.id !== currentDetailId);
    localStorage.setItem('journal', JSON.stringify(journal));
    closeEntryDetail();
    renderJournal();
  }

  // ‚îÄ‚îÄ TAG MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderDetailTags() {
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry) return;
    const row = document.getElementById('customTagsRow');
    const tags = entry.customTags || [];
    row.innerHTML = tags.length
      ? tags.map((t, i) => `
          <span class="ctag-pill ctag-${t.category}">
            ${escHtml(t.label)}
            <button class="ctag-remove" onclick="removeCustomTag(${i})">√ó</button>
          </span>`).join('')
      : '<span style="font-size:12px;color:var(--muted)">No custom tags yet</span>';
  }

  function addCustomTag() {
    const label = document.getElementById('tagLabelInput').value.trim();
    if (!label) return;
    const cat   = document.getElementById('tagCatSelect').value;
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry) return;
    if (!entry.customTags) entry.customTags = [];
    if (entry.customTags.some(t => t.label === label)) {
      document.getElementById('tagLabelInput').value = '';
      return;
    }
    entry.customTags.push({ label, category: cat });
    localStorage.setItem('journal', JSON.stringify(journal));
    document.getElementById('tagLabelInput').value = '';
    renderDetailTags();
    renderJournal();
  }

  function removeCustomTag(idx) {
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry || !entry.customTags) return;
    entry.customTags.splice(idx, 1);
    localStorage.setItem('journal', JSON.stringify(journal));
    renderDetailTags();
    renderJournal();
  }

  // ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function enterEditMode() {
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry) return;
    document.getElementById('editTextarea').value   = entry.content;
    document.getElementById('editTitleInput').value = entry.title;
    document.getElementById('editDateInput').value  = entry.date;
    document.getElementById('editDateInput').max    = todayKey();
    document.getElementById('entryViewMode').style.display = 'none';
    document.getElementById('entryEditMode').style.display = '';
  }

  function saveEdit() {
    const content  = document.getElementById('editTextarea').value.trim();
    const title    = document.getElementById('editTitleInput').value.trim();
    const newDate  = document.getElementById('editDateInput').value || todayKey();
    if (!content) return;
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry) return;
    const oldDate  = entry.date;
    entry.content  = content;
    entry.title    = title || generateTitle(content);
    entry.date     = newDate;
    localStorage.setItem('journal', JSON.stringify(journal));

    // Tick journal habit for new date
    const newLog = getLog(newDate);
    newLog.habits['h-journal'] = 'full';
    // If date changed and no other entries remain on old date, untick old date
    if (newDate !== oldDate) {
      const stillOnOldDate = journal.some(e => e.id !== currentDetailId && e.date === oldDate);
      if (!stillOnOldDate) {
        const oldLog = getLog(oldDate);
        delete oldLog.habits['h-journal'];
      }
    }
    persist();

    // Refresh view mode
    document.getElementById('detailContent').textContent = entry.content;
    document.getElementById('detailTitle').textContent   = entry.title;
    document.getElementById('detailMeta').textContent    = formatEntryDate(entry.date) + ' ¬∑ ' + entry.prompt;
    cancelEdit();
    renderJournal();
  }

  function cancelEdit() {
    document.getElementById('entryViewMode').style.display = '';
    document.getElementById('entryEditMode').style.display = 'none';
  }

  // ‚îÄ‚îÄ OBSIDIAN EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportToObsidian() {
    const entry = journal.find(e => e.id === currentDetailId);
    if (!entry) return;
    const blob = new Blob([generateMd(entry)], { type: 'text/markdown' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = sanitizeFilename(entry.title) + '.md';
    a.click();
    URL.revokeObjectURL(url);
    entry.exported = true;
    localStorage.setItem('journal', JSON.stringify(journal));
    // Update meta line to show exported
    document.getElementById('detailMeta').textContent =
      formatEntryDate(entry.date) + ' ¬∑ ' + entry.prompt + ' ¬∑ exported';
    renderJournal();
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function init() {
    document.getElementById('hEye').textContent =
      today.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    renderToday();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  })();
</script>
</body>
</html>
